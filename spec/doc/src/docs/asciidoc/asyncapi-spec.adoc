//
// Copyright (C) open knowledge GmbH
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions
// and limitations under the License.
//

:authors: Stephan Mueller
:email: stephan.mueller@openknowledge.de
:version-label!:
:sectanchors:
:doctype: book
:license: Apache License v2.0
:source-highlighter: coderay
:sectnums:
:toc: left
:toclevels: 4
ifdef::backend-pdf[]
:pagenums:
endif::[]

= AsyncAPI Spec

include::license-alv2.asciidoc[]


== Introduction
Exposing APIs has become an essential part of all modern applications.  At the
center of this revolution known as the API Economy we find RESTful APIs, which can
transform any application into language agnostic services that can be called from
anywhere: on-premises, private cloud, public cloud, etc. Now revolution continues
by focusing on asynchronous APIs.

For the clients and providers of these services to connect there needs to be a
clear and complete contract. Similar to the OpenAPI v3 specification for RESTful
Services the https://github.com/asyncapi/smallrye-async-api/blob/master/spec/versions/2.0.0/asyncapi.md[AsyncAPI v2]
specification is the contract for event based communication between services.

This MicroProfile specification, called AsyncAPI 1.0, aims to provide a set of Java
interfaces and programming models which allow Java developers to natively produce
AsyncAPI v2 documents from their applications.

== Architecture

There are different ways to augment an application in order to produce an
AsyncAPI document, which are described in <<Documentation Mechanisms>>.  The picture
below provides a quick overview of the different types of components that make up
the AsyncAPI specification:

:imagesdir: images
image::diagram.png[Architecture Diagram]

The remaining sections of this specification will go into the details of each component.

== Configuration

Configuration of various parts of this specification is provided via the https://github.com/eclipse/microprofile-config[MicroProfile Config] mechanism,
which means that vendors implementing the AsyncAPI specification must also implement
the MP Config specification.

There are various ways to inject these configuration values into an AsyncAPI
framework, including the https://github.com/eclipse/microprofile-config/blob/master/spec/src/main/asciidoc/configsources.asciidoc#default-configources[default ConfigSource] as well as
https://github.com/eclipse/microprofile-config/blob/master/spec/src/main/asciidoc/configsources.asciidoc#custom-configsources[custom ConfigSource].

Vendors implementing the AsyncAPI specification can optionally provide additional native
ways for these configuration values to be injected into the framework
(e.g. via a server configuration file), as long as they also implement the MP Config
specification.


=== List of configurable items

Vendors must support all the <<Core configurations>> of this specification.
Optionally, they may also support <<Vendor extensions>> that allow the configuration of
framework-specific values for configurations that affect implementation behavior.

For convenience of vendors (and application developers using custom ConfigSources),
the full list of supported configuration keys is available as constants in the
https://github.com/eclipse/microprofile-open-api/blob/master/api/src/main/java/org/eclipse/microprofile/openapi/OASConfig.java[OASConfig] class.

==== Core configurations

The following is a list of configuration values that every vendor must support.

`mp.asyncapi.model.reader`::
Configuration property to specify the fully qualified name of the <<AASModelReader>> implementation.

`mp.asyncapi.filter`::
Configuration property to specify the fully qualified name of the <<AASFilter>> implementation.

`mp.asyncapi.scan.disable`::
Configuration property to disable annotation scanning. Default value is `false`.

`mp.asyncapi.scan.packages`::
Configuration property to specify the list of packages to scan. For example,
`mp.asyncapi.scan.packages=com.xyz.PackageA,com.xyz.PackageB`

`mp.asyncapi.scan.classes`::
Configuration property to specify the list of classes to scan. For example,
`mp.asyncapi.scan.classes=com.xyz.MyClassA,com.xyz.MyClassB`

`mp.asyncapi.scan.exclude.packages`::
Configuration property to specify the list of packages to exclude from scans. For example,
`mp.asyncapi.scan.exclude.packages=com.xyz.PackageC,com.xyz.PackageD`

`mp.asyncapi.scan.exclude.classes`::
Configuration property to specify the list of classes to exclude from scans. For example,
`mp.asyncapi.scan.exclude.classes=com.xyz.MyClassC,com.xyz.MyClassD`

`mp.asyncapi.schema.`::
Prefix of the configuration property to specify a schema for a specific class, in JSON format.
The remainder of the property key must be the fully-qualified class name. The value must be a valid AsyncAPI schema object,
specified in the JSON format. The use of this property is functionally equivalent to the use of the `@Schema` annotation on
a Java class, but may be used in cases where the application developer does not have access to the source code of a class. +
+
When a `name` key is provided with a string value, the schema will be added to the `schemas` collection in the `components`
object of the resulting AsyncAPI document using ``name``'s value as the key.
+
For example, in the case where an application wishes to represent Java ``Date``s in epoch milliseconds, the following configuration could be used (line
escapes and indentation added for readability):
[source, json]
----
mp.asyncapi.schema.java.util.Date = { \
  "name": "EpochMillis" \
  "type": "number", \
  "format": "int64", \
  "description": "Milliseconds since January 1, 1970, 00:00:00 GMT" \
}
----

==== Vendor extensions

Vendors that wish to provide vendor-specific configuration via MP Config (instead
of another native configuration framework) must use the prefix `mp.asyncapi.extensions`.

== Documentation Mechanisms

There are many different ways to provide input for the generation of the resulting
AsyncAPI document.

The AsyncAPI specification requires vendors to produce a valid AsyncAPI document
from pure JMS and MP Reactive Messaging applications. This means that vendors must
process all the relevant JMS and MP Reactive Messaging annotations and configuration
as well as Java objects (POJOs) used as incoming or outgoing message.  This is a
good place to start for application developers that are new to AsyncAPI: just deploy
your existing application into a AsyncAPI vendor and check out the output from
`/asyncapi`!

The application developer then has a few choices:

1.  Augment those JMS and MP Reactive Messaging annotations and configuration with
the AsyncAPI <<Annotations>>.  Using annotations means developers don't have to
re-write the portions of the AsyncAPI document that are already covered by the
message API.

2. Take the initial output from `/asyncapi` as a starting point to document
your APIs via <<Static AsyncAPI files>>.  It's worth mentioning that these static
files can also be written before any code, which is an approach often adopted by
enterprises that want to lock-in the contract of the API.  In this case, we refer
to the AsyncAPI document as the "source of truth", by which the client and provider
must abide.

3. Use the <<Programming model>> to provide a bootstrap (or complete)
AsyncAPI model tree.

Additionally, a <<Filter>> is described which can update the AsyncAPI model after it has
been built from the previously described documentation mechanisms.

=== Annotations

==== Overview of annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations[de.openknowledge.microprofile.asyncapi.annotations] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/AsyncAPI.java[@AsyncAPI] | General metadata for an AsyncAPI definition.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/channel/ChannelItem.java[@ChannelItem] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/channel/Channels.java[@Channels] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/Components.java[@Components] | A container that holds various reusable objects for different aspects of the AsyncAPI Specification.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/info/Contact.java[@Contact] | Contact information for the exposed API.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/message/CorrelationID.java[@CorrelationID] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/extensions/Extension.java[@Extension] | Adds an extension with contained properties.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/extensions/Extensions.java[@Extensions] | Adds custom properties to an extension.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/extensions/ExternalDocumentation.java[@ExternalDocumentation] | References an external resource for extended documentation.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/info/Info.java[@Info] | This annotation encapsulates metadata about the API.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/info/License.java[@License] | License information for the exposed API.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/message/Message.java[@Message] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/message/MessageTraint.java[@MessageTrait] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/security/OAuthFlow.java[@OAuthFlow] | Configuration details for a supported OAuth Flow.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/security/OAuthFlows.java[@OAuthFlows] | Allows configuration of the supported OAuth Flows.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/security/OAuthScope.java[@OAuthScope] | Represents an OAuth scope.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/operation/Operation.java[@Operation] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/operation/OperationTrait.java[@OperationTrait] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/parameter/Parameter.java[@Parameter] | Describes a single channel parameter.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/parameter/Parameters.java[@Parameters] | Encapsulates parameters.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/Reference.java[@Reference] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/schema/Schema.java[@Schema] | Allows the definition of input and output data types.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/schema/SchemaProperty.java[@SchemaProperty] | Allows the definition of a property nested within a parent @Schema.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/schema/SchemaType.java[@SchemaType] | Enumeration for the schema property's type property
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/security/SecurityRequirement.java[@SecurityRequirement] | Specifies a security requirement for an operation.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/security/SecurityScheme.java[@SecurityScheme] | Defines a security scheme that can be used by the operations.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/security/SecuritySchemeIn.java[@SecuritySchemeIn] | Enumeration for the security scheme’s in property.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/security/SecuritySchemes.java[@SecuritySchemes] | Represents an array of security schemes that can be specified.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/security/SecuritySchemeType.java[@SecuritySchemeType] | Enumeration for the security scheme’s type property.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/server/Server.java[@Server] | Represents a broker used to publish or subscribe by a channel in an AsyncAPI document.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/server/Servers.java[@Servers] | A container for multiple server definitions.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/server/ServerVariable.java[@ServerVariable] | Represents a server variable for server URL template substitution.
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/tag/Tag.java[@Tag] | Represents a tag
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/tag/Tags.java[@Tags] | A container of multiple tags.
|===

===== Overview of binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding[de.openknowledge.microprofile.asyncapi.annotations.binding] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/ChannelBinding.java[@ChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/ChannelBindings.java[@ChannelBindings] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/MessageBinding.java[@MessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/MessageBindings.java[@MessageBindings] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/OperationBinding.java[@OperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/OperationBindings.java[@OperationBindings] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/ServerBinding.java[@ServerBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/ServerBindings.java[@ServerBindings] |
|===


===== AMQP binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp[de.openknowledge.microprofile.asyncapi.annotations.binding.amqp] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp/AMQPChannelBinding.java[@AMQPChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp/AMQPMessageBinding.java[@AMQPMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp/AMQPOperationBinding.java[@AMQPOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp/AMQPServerBinding.java[@AMQPServerBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp/Exchange.java[@Exchange] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp/ExchangeType.java[@ExchangeType] | Enumeration for the exchange type property
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp/Queue.java[@Queue] |
|===

===== AMQP1 binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp1[de.openknowledge.microprofile.asyncapi.annotations.binding.amqp1] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp1/AMQP1ChannelBinding.java[@AMQP1ChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp1/AMQP1MessageBinding.java[@AMQP1MessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp1/AMQP1OperationBinding.java[@AMQP1OperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/amqp1/AMQP1ServerBinding.java[@AMQP1ServerBinding] |
|===

===== HTTP binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/http[de.openknowledge.microprofile.asyncapi.annotations.binding.http] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/http/HTTPChannelBinding.java[@HTTPChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/http/HTTPMessageBinding.java[@HTTPMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/http/HTTPOperationBinding.java[@HTTPOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/http/HTTPServerBinding.java[@HTTPServerBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/http/Method.java[@Method] | Enumeration for the operation method property
|===

===== JMS binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/jms[de.openknowledge.microprofile.asyncapi.annotations.binding.jms] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/jms/JMSChannelBinding.java[@JMSChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/jms/JMSMessageBinding.java[@JMSMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/jms/JMSOperationBinding.java[@JMSOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/jms/JMSServerBinding.java[@JMSServerBinding] |
|===

===== Kafka binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/kafka[de.openknowledge.microprofile.asyncapi.annotations.binding.kafka] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/kafka/KafkaChannelBinding.java[@KafkaChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/kafka/KafkaMessageBinding.java[@KafkaMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/kafka/KafkaOperationBinding.java[@KafkaOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/kafka/KafkaServerBinding.java[@KafkaServerBinding] |
|===

===== MQTT binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt[de.openknowledge.microprofile.asyncapi.annotations.binding.mqtt] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt/LastWill.java[@LastWill] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt/MQTTChannelBinding.java[@MQTTChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt/MQTTMessageBinding.java[@MQTTMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt/MQTTOperationBinding.java[@MQTTOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt/MQTTServerBinding.java[@MQTTServerBinding] |
|===

===== MQTT5 binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt5[de.openknowledge.microprofile.asyncapi.annotations.binding.mqtt5] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt/MQTT5ChannelBinding.java[@MQTT5ChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt/MQTT5MessageBinding.java[@MQTT5MessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt/MQTT5OperationBinding.java[@MQTT5OperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/mqtt/MQTT5ServerBinding.java[@MQTT5ServerBinding] |
|===

===== NATS binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/nats[de.openknowledge.microprofile.asyncapi.annotations.binding.nats] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/nats/NATSChannelBinding.java[@NATSChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/nats/NATSMessageBinding.java[@NATSMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/nats/NATSOperationBinding.java[@NATSOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/nats/NATSServerBinding.java[@NATSServerBinding] |
|===

===== Redis binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/redis[de.openknowledge.microprofile.asyncapi.annotations.binding.redis] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/redis/RedisChannelBinding.java[@RedisChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/redis/RedisMessageBinding.java[@RedisMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/redis/RedisOperationBinding.java[@RedisOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/redis/RedisServerBinding.java[@RedisServerBinding] |
|===

===== SNS binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sns[de.openknowledge.microprofile.asyncapi.annotations.binding.sns] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sns/SNSChannelBinding.java[@SNSChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sns/SNSMessageBinding.java[@SNSMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sns/SNSOperationBinding.java[@SNSOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sns/SNSServerBinding.java[@SNSServerBinding] |
|===

===== SQS binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sqs[de.openknowledge.microprofile.asyncapi.annotations.binding.sqs] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sqs/SQSChannelBinding.java[@SQSChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sqs/SQSMessageBinding.java[@SQSMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sqs/SQSOperationBinding.java[@SQSOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/sqs/SQSServerBinding.java[@SQSServerBinding] |
|===

===== STOMP binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/stomp[de.openknowledge.microprofile.asyncapi.annotations.binding.stomp] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/stomp/STOMPChannelBinding.java[@STOMPChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/stomp/STOMPMessageBinding.java[@STOMPMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/stomp/STOMPOperationBinding.java[@STOMPOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/stomp/STOMPServerBinding.java[@STOMPServerBinding] |
|===

===== WebSocket binding annotations

The following annotations are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/ws[de.openknowledge.microprofile.asyncapi.annotations.binding.ws] package.

[cols="1,4"]
|===
| Annotation | Description
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/ws/WebSocketChannelBinding.java[@WebSocketChannelBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/ws/WebSocketMessageBinding.java[@WebSocketMessageBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/ws/WebSocketOperationBinding.java[@WebSocketOperationBinding] |
| https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/io/smallrye/asyncapi/spec/annotations/binding/ws/WebSocketServerBinding.java[@WebSocketServerBinding] |
|===

==== Detailed usage of key annotations

===== Channel

.Sample 1 - Simple channel description
[source,Java]
----
@ChannelItem(channel = "light/measured",
  publish = @Operation(
    summary = "Inform about environmental lighting conditions for a particular streetlight.",
    operationId = "onLightMeasured",
    message = @Message(payload = @Schema(name = "dim",
      type = SchemaType.OBJECT,
      properties = {
        @SchemaProperty(name = "id",
          type = SchemaType.INTEGER,
          description = "Id of the streetlight.",
          minimum = "0"
        ),
        @SchemaProperty(name = "lumens",
          type = SchemaType.INTEGER,
          description = "Light intensity measured in lumens.",
          minimum = "0"
        ),
        @SchemaProperty(name = "sentAt",
          type = SchemaType.STRING,
          format = "date-time",
          description = "Date and time when the message was sent."
        ),
      }
    ))
  )
)
@Outgoing("onLightMeasured")
public Multi<MqttMessage<Dim>> dim() { ... }
----

.Output for Sample 1
[source, yaml]
----
channels:
  light/measured:
    publish:
      summary: Inform about environmental lighting conditions for a particular streetlight.
      operationId: onLightMeasured
      message:
        payload:
          type: object
          properties:
            id:
              type: integer
              minimum: 0
              description: Id of the streetlight.
            lumens:
              type: integer
              minimum: 0
              description: Light intensity measured in lumens.
            sentAt:
              type: string
              format: date-time
              description: Date and time when the message was sent.
----

===== Servers

.Sample 1 - Server scenarios
[source,Java]
----
@AsyncAPI(
  asyncapi = "2.0.0",
  info = @Info(
    title = "Streetlights API",
    version = "1.0.0",
    description = "The Smartylighting Streetlights API allows you to remotely manage the city lights.",
    license = @License(
      name = "Apache 2.0",
      url = "https://www.apache.org/licenses/LICENSE-2.0"
    )
  ),
  servers = {
    @Server(
      url = "mqtt://test.mosquitto.org",
      protocol = "mqtt"
    )
  }
)
public class StreetlightsApp { ... }
----

.Output for Sample 1
[source, yaml]
----
info:
  title: Streetlights API
  version: '1.0.0'
  description: |
    The Smartylighting Streetlights API allows you
    to remotely manage the city lights.
  license:
    name: Apache 2.0
    url: 'https://www.apache.org/licenses/LICENSE-2.0'
servers:
  mosquitto:
    url: mqtt://test.mosquitto.org
    protocol: mqtt
----

===== Schema

.Sample 1 - Schema POJO
[source,Java]
----
@Schema
public class Dim {

  @SchemaProperty(description = "Id of the streetlight.", minimum = "0")
  private int id;

  @SchemaProperty(description = "Light intensity measured in lumens.", minimum = "0")
  private int percentage;

  @SchemaProperty(description = "Date and time when the message was sent.",
    type = SchemaType.STRING,
    format = "date-time")
  private LocalDateTime sentAt;

  ...
}
----

.Output for Sample 1
[source, yaml]
----
components:
  messages:
    dim:
      payload:
        type: object
        properties:
          id:
            type: integer
            minimum: 0
            description: Id of the streetlight.
          lumens:
            type: integer
            minimum: 0
            description: Light intensity measured in lumens.
          sentAt:
            type: string
            format: date-time
            description: Date and time when the message was sent.
----


.Sample 2 - Schema POJO reference
[source,Java]
----
@ChannelItem(channel = "light/measured",
  publish = @Operation(
    summary = "Inform about environmental lighting conditions for a particular streetlight.",
    operationId = "onLightMeasured",
    message = @Message(ref = @Reference(ref = "#/components/messages/dim"))
  )
)
@Outgoing("onLightMeasured")
public Multi<MqttMessage<Dim>> dim() { ... }
----

.Output for Sample 2
[source, yaml]
----
channels:
  light/measured:
    publish:
      summary: Inform about environmental lighting conditions for a particular streetlight.
      operationId: onLightMeasured
      message:
        $ref: '#/components/messages/dim'
----


For more samples please see the https://github.com/openknowledge/asyncapi/wiki[Wiki].

=== Static AsyncAPI files

Application developers may wish to include a pre-generated AsyncAPI document that
was written separately from the code (e.g. with an editor such as https://playground.asyncapi.io/[this]).

Depending on the scenario, the document may be fully complete or partially complete.
If a document is fully complete then the application developer will want to set the
`mp.asyncapi.scan.disable` configuration property to `true`.  If a document is partially
complete, then the application developer will need to augment the AsyncAPI snippet
with annotations, programming model, or via the filter.

==== Location and formats

Vendors are required to fetch a single document named `openapi` with an extension
of `yml`, `yaml` or `json`, inside the application module's root
`META-INF` folder.  If there is more than one document found that matches one of
these extensions the behavior of which file is chosen is undefined (i.e. each vendor
may implement their own logic), which means that application developers should
only place a single `openapi` document into that folder.

For convenience, you may also place your `microprofile-config.properties` in the
root `META-INF` folder, if you wish to keep both documents in the same directory.
This is in addition to the default locations defined by https://github.com/eclipse/microprofile-config[MicroProfile Config].

=== Programming model

Application developers are able to provide AsyncAPI elements via Java POJOs. The
complete set of models are found in the https://github.com/openknowledge/smallrye-async-api/tree/master/spec/api/src/main/java/com/asyncapi/asyncapi/models[com.asyncapi.models] package.

==== AASFactory

The https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/com/asyncapi/AASFactory.java[AASFactory] is used to create all of the elements of an AsyncAPI tree.

For example, the following snippet creates a simple https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/com/asyncapi/models/info/Info.java[Info] element that contains a title, description, and version.

[source,java]
----
AASFactory.createObject(Info.class).title("Streetlights API").description("Streetlights API").version("1.0.0");
----

==== AASModelReader

The https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/com/asyncapi/AASModelReader.java[AASModelReader] interface allows application developers to bootstrap the AsyncAPI model tree
used by the processing framework.  To use it, simply create an implementation of
this interface and register it using the `mp.asyncapi.model.reader` configuration
key, where the value is the fully qualified name of the reader class.

.Sample META-INF/microprofile-config.properties
[source,property]
----
mp.asyncapi.model.reader=com.mypackage.MyModelReader
----

Similar to static files, the model reader can be used to provide either complete
or partial model trees. If providing a complete AsyncAPI model tree, application
developers should set the `mp.asyncapi.scan.disable` configuration to `true`.
Oherwise this partial model will be used as the base model during the processing
of the other <<Documentation Mechanisms>>.

Vendors are required to call the AASReader a single time, in the order defined by
the <<Processing rules>> section.  Only a single AASReader instance is allowed per
application.

=== Filter

There are many scenarios where application developers may wish to update or remove
certain elements and fields of the AsyncAPI document.  This is done via a filter,
which is called once after all other documentation mechanisms have completed.

==== AASFilter

The https://github.com/openknowledge/smallrye-async-api/blob/master/spec/api/src/main/java/com/asyncapi/AASFilter.java[AASFilter] interface allows application developers
to receive callbacks for various key AsyncAPI elements.  The interface has a default
implementation for every method, which allows application developers to only override
the methods they care about.  To use it, simply create an implementation of
this interface and register it using the `mp.asyncapi.filter` configuration
key, where the value is the fully qualified name of the filter class.

.Sample META-INF/microprofile-config.properties
[source,property]
----
mp.asyncapi.filter=com.mypackage.MyFilter
----

Vendors are required to call the registered filter once for each filtered element.

For example, the method `filterChannelItem` is called *for each* corresponding `ChannelItem`
element in the model tree.  This allows application developers to filter the element
and any of its descendants.

The order of filter methods called is undefined, with two exceptions:

1.  All filterable descendant elements of a filtered element must be called before its ancestor.
2.  The `filterAsyncAPI` method must be the *last* method called on a filter (which
is just a specialization of the first exception).

=== Processing rules

The processed document available from the <<AsyncAPI Endpoint>> is built from a variety of sources,
which were outlined in the sub-headings of <<Documentation Mechanisms>>.  Vendors
are required to process these different sources in the following order:

1. Fetch configuration values from `mp.asyncapi` namespace
2. Call AASModelReader
3. Fetch static AsyncAPI file
4. Process annotations
5. Filter model via AASFilter

**Example processing**:

* A vendor starts by fetching all available <<Configuration>>.  If
an `AASModelReader` was specified in that configuration list, its `buildModel`
method is called to form the starting AsyncAPI model tree for this application.
* Any <<Vendor extensions>> are added on top of that starting model (overriding
conflicts), or create a new model if an `AASModelReader` was not registered.
* The vendor searches for a file as defined in the section <<Static AsyncAPI files>>.
If found, it will read that document and merge with the model produced by previous
processing steps (if any), where conflicting elements from the static file will override
the values from the original model.
* If annotation scanning was not disabled, the AsyncAPI annotations from the
application will be processed, further overriding any conflicting elements from
the current model.
* The final model is filtered by walking the model tree and invoking all registered
<<AASFilter>> classes.

== AsyncAPI Endpoint

=== Overview
A fully processed AsyncAPI document must be available at the root
URL `/asyncapi`, as a `HTTP GET` operation.

For example, `GET http://myHost:myPort/asyncapi`.

This document represents the result of the applied <<Processing rules>>.

The protocol required is `http`.  Vendors are encouraged, but not required, to
support the `https` protocol as well, to enable a secure connection to the AsyncAPI
endpoint.

=== Content format
The default format of the `/asyncapi` endpoint is `YAML`.

Vendors must also support the `JSON` format if the request contains an `Accept`
header with a value of `application/json`, in which case the response must contain
a `Content-Type` header with a value of `application/json`.

=== Query parameters
No query parameters are required for the `/asyncapi` endpoint.  However, one
suggested but optional query parameter for vendors to support is `format`,
where the value can be either `JSON` or `YAML`, to facilitate the toggle between
the default `YAML` format and `JSON` format.

=== Context root behavior (TODO FIXME)
// Vendors are required to ensure that the combination of each global https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#serverObject[server]
// element and https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#pathItemObject[pathItem] element resolve to the absolute backend URL of that
// particular path.  If that `pathItem` contains a `servers` element , then this
// list of operation-level `server` elements replaces the global list of servers
// for that particular `pathItem`.

// For example:  an application may have an `ApplicationPath` annotation with the
// value of `/`, but is assigned the context root of `/myApp` during deployment. In
// this case, the `server` elements (either global or operation-level) must either
// end with `/myApp` or a corresponding proxy.  Alternatively it is valid, but discouraged, to
// add that context root (`/myApp`) to every `pathItem` defined in that application.

=== Multiple applications

The 1.0 version of the OK-Profile AsyncAPI specification does not define how
the `/asyncapi` endpoint may be partitioned in the event that the MicroProfile
runtime supports deployment of multiple applications. If an implementation wishes
to support multiple applications within a MicroProfile runtime, the semantics of
the `/asyncapi` endpoint are expected to be the logical union of all the applications
in the runtime, which would imply merging multiple AsyncAPI documents into a single
valid document (handling conflicting IDs and unique names).

== Integration with other MicroProfile specifications

This section will outline specific integrations between OK-Profile AsyncAPI and other MicroProfile specifications.

== Limitations

=== Internationalization
The 1.0 version of the OK-Profile AsyncAPI spec does not require vendors to
support multiple languages based on the `Accept-Language`.  One reasonable
approach is for vendors to support unique keys (instead of hardcoded text) via
the various <<Documentation Mechanisms>>, so that the implementing framework can
perform a global replacement of the keys with the language-specific text that
matches the `Accept-Language` request for the `/asyncapi` endpoint.  A cache of
processed languages can be kept to improve performance.

=== Validation

The AsyncAPI specification does not mandate vendors to validate the resulting
AsyncAPI v2 model (after processing the 5 steps previously mentioned), which means
that the behavior of invalid models is vendor specific (i.e. vendors may choose to
ignore, reject, or pass-through invalid inputs).

=== Cross Origin Resource Sharing (CORS)

The AsyncAPI specification does not require vendors to support https://www.w3.org/TR/cors/[CORS]
for the `/asyncapi` endpoint.  The behavior of CORS requests is implementation dependent.

include::release_notes.asciidoc[]
